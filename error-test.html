<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Manejo de Errores HTTP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #dcfce7; border: 1px solid #16a34a; }
        .error { background: #fef2f2; border: 1px solid #dc2626; }
        .network { background: #fef3c7; border: 1px solid #d97706; }
    </style>
</head>
<body>
    <h1>üß™ Test de Manejo de Errores HTTP</h1>
    
    <div class="test-container">
        <h2>Pruebas de Errores de Red</h2>
        <button class="test-button" onclick="testNetworkError()">Test Error de Conexi√≥n</button>
        <button class="test-button" onclick="testTimeoutError()">Test Timeout</button>
        <button class="test-button" onclick="testHttpErrors()">Test Errores HTTP</button>
        <div id="results"></div>
    </div>

    <div class="test-container">
        <h2>Simulaci√≥n de Errores CheckIn</h2>
        <button class="test-button" onclick="simulateCheckInErrors()">Simular Errores CheckIn</button>
        <div id="checkin-results"></div>
    </div>

    <script>
        // Simulated API client with error handling
        class TestApiClient {
            async makeRequest(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: options.timeout ? AbortSignal.timeout(options.timeout) : undefined
                    });
                    
                    if (!response.ok) {
                        const error = new Error(`HTTP error! status: ${response.status}`);
                        error.status = response.status;
                        error.response = { data: await response.json().catch(() => null) };
                        throw error;
                    }
                    
                    return await response.json();
                } catch (error) {
                    if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                        const timeoutError = new Error('Tiempo de espera agotado');
                        timeoutError.status = 0;
                        timeoutError.type = 'timeout';
                        timeoutError.response = { data: null };
                        throw timeoutError;
                    } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        const networkError = new Error('Error de conexi√≥n');
                        networkError.status = 0;
                        networkError.type = 'network';
                        networkError.response = { data: null };
                        throw networkError;
                    }
                    throw error;
                }
            }
        }

        const apiClient = new TestApiClient();

        function addResult(containerId, message, type = 'success') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `result ${type}`;
            result.textContent = message;
            container.appendChild(result);
        }

        async function testNetworkError() {
            try {
                await apiClient.makeRequest('http://invalid-domain-that-does-not-exist.com/api');
            } catch (error) {
                addResult('results', 
                    `‚úÖ Error de Red Capturado:\n` +
                    `Mensaje: ${error.message}\n` +
                    `Tipo: ${error.type}\n` +
                    `Status: ${error.status}`, 
                    'network'
                );
            }
        }

        async function testTimeoutError() {
            try {
                await apiClient.makeRequest('https://httpbin.org/delay/5', { timeout: 100 });
            } catch (error) {
                addResult('results', 
                    `‚úÖ Error de Timeout Capturado:\n` +
                    `Mensaje: ${error.message}\n` +
                    `Tipo: ${error.type}\n` +
                    `Status: ${error.status}`, 
                    'network'
                );
            }
        }

        async function testHttpErrors() {
            const testCases = [
                { url: 'https://httpbin.org/status/400', expected: 400 },
                { url: 'https://httpbin.org/status/401', expected: 401 },
                { url: 'https://httpbin.org/status/404', expected: 404 },
                { url: 'https://httpbin.org/status/500', expected: 500 }
            ];

            for (const testCase of testCases) {
                try {
                    await apiClient.makeRequest(testCase.url);
                } catch (error) {
                    addResult('results', 
                        `‚úÖ HTTP ${testCase.expected} Capturado:\n` +
                        `Mensaje: ${error.message}\n` +
                        `Status: ${error.status}`, 
                        'error'
                    );
                }
            }
        }

        function simulateCheckInErrors() {
            const testCases = [
                {
                    name: 'Error de Red',
                    error: { type: 'network', status: 0, message: 'Error de conexi√≥n' }
                },
                {
                    name: 'Timeout',
                    error: { type: 'timeout', status: 0, message: 'Tiempo de espera agotado' }
                },
                {
                    name: 'Sin Rostro Detectado',
                    error: { 
                        status: 400, 
                        response: { 
                            data: { 
                                message: 'No face detected', 
                                detail: 'Please position your face clearly' 
                            } 
                        } 
                    }
                },
                {
                    name: 'Rostro No Reconocido',
                    error: { 
                        status: 401, 
                        response: { 
                            data: { 
                                message: 'Face not recognized', 
                                detail: 'Face not found in system' 
                            } 
                        } 
                    }
                }
            ];

            testCases.forEach(testCase => {
                const err = testCase.error;
                const errorType = err?.type;
                const status = err?.status;
                
                let errorResult;
                
                if (errorType === 'network') {
                    errorResult = {
                        success: false,
                        message: 'Error de conexi√≥n',
                        reason: 'system_error',
                        detail: 'No se pudo conectar al servidor. Por favor verifica tu conexi√≥n a internet e intenta de nuevo.'
                    };
                } else if (errorType === 'timeout') {
                    errorResult = {
                        success: false,
                        message: 'Tiempo de espera agotado',
                        reason: 'system_error',
                        detail: 'La solicitud tard√≥ demasiado tiempo. Por favor verifica tu conexi√≥n e intenta de nuevo.'
                    };
                } else if (status === 400) {
                    const apiMessage = err.response?.data?.message || '';
                    const apiDetail = err.response?.data?.detail || '';
                    errorResult = {
                        success: false,
                        message: apiMessage || 'No se detect√≥ rostro en la imagen',
                        reason: 'no_face_detected',
                        detail: apiDetail || 'Por favor aseg√∫rate de que tu rostro est√© claramente visible.'
                    };
                } else if (status === 401) {
                    const apiMessage = err.response?.data?.message || '';
                    const apiDetail = err.response?.data?.detail || '';
                    errorResult = {
                        success: false,
                        message: apiMessage || 'Rostro no reconocido',
                        reason: 'face_not_recognized',
                        detail: apiDetail || 'Tu rostro no fue reconocido en nuestro sistema.'
                    };
                }
                
                addResult('checkin-results', 
                    `üß™ ${testCase.name}:\n` +
                    `Mensaje: ${errorResult.message}\n` +
                    `Raz√≥n: ${errorResult.reason}\n` +
                    `Detalle: ${errorResult.detail}`, 
                    errorType === 'network' || errorType === 'timeout' ? 'network' : 'error'
                );
            });
        }
    </script>
</body>
</html>
